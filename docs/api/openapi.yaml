openapi: 3.0.3
info:
  title: HausHaltsMeister API
  description: |
    API para controle financeiro pessoal focado em fluxo de caixa e integridade de dados.

    Principais características:
    - Focado em CashFlow (Fluxo de Caixa)
    - Suporte a Orçamento (Budget) e Picuinhas
    - Single-user
    - Autenticação via X-App-Token
  version: 0.1.0
servers:
  - url: http://localhost:8080
    description: Local Server

tags:
  - name: Categories
    description: Gerenciamento de categorias de fluxo.
  - name: CashFlows
    description: Núcleo do sistema - entradas e saídas.
  - name: Budgets
    description: Planejamento orçamentário.
  - name: Picuinhas
    description: Controle de empréstimos e divisões.
  - name: Cards
    description: Cartões de crédito e parcelamentos.

paths:
  # ----------------------------------------------------------------------------
  # Categories
  # ----------------------------------------------------------------------------
  /categories:
    get:
      summary: Listar Categorias
      tags: [Categories]
      parameters:
        - in: query
          name: active
          schema:
            type: boolean
          description: Filtrar apenas ativas (true)
      responses:
        "200":
          description: Lista de categorias
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CategoryResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Criar Categoria
      tags: [Categories]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCategoryRequest"
      responses:
        "201":
          description: Categoria criada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ----------------------------------------------------------------------------
  # CashFlows
  # ----------------------------------------------------------------------------
  /cashflows:
    get:
      summary: Listar Fluxos (Extrato)
      tags: [CashFlows]
      parameters:
        - in: query
          name: month
          schema:
            type: string
            format: date
            example: "2024-03-01"
          description: Mês de referência (YYYY-MM-DD, dia 1 obrigatório internamente)
      responses:
        "200":
          description: Lista de lançamentos do mês
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CashFlowResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      summary: Criar Lançamento
      tags: [CashFlows]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCashFlowRequest"
      responses:
        "201":
          description: Lançamento criado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CashFlowResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /cashflows/summary:
    get:
      summary: Resumo Mensal
      tags: [CashFlows]
      parameters:
        - in: query
          name: month
          required: true
          schema:
            type: string
            format: date
            example: "2024-03-01"
      responses:
        "200":
          description: Resumo financeiro do mês
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MonthlySummaryResponse"

  /cashflows/category-summary:
    get:
      summary: Resumo por Categoria
      tags: [CashFlows]
      parameters:
        - in: query
          name: month
          required: true
          schema:
            type: string
            format: date
            example: "2024-03-01"
      responses:
        "200":
          description: Agrupamento por categoria
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CategorySummaryResponse"

  /cashflows/copy-fixed:
    post:
      summary: Copiar Gastos Fixos
      tags: [CashFlows]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CopyFixedRequest"
      responses:
        "200":
          description: Sucesso na cópia
          content:
            application/json:
              schema:
                type: object
                properties:
                  copied_count:
                    type: integer

  # ----------------------------------------------------------------------------
  # Budgets
  # ----------------------------------------------------------------------------
  /budgets/{month}/items:
    post:
      summary: Definir Item de Orçamento
      tags: [Budgets]
      parameters:
        - in: path
          name: month
          required: true
          schema:
            type: string
            format: date
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetBudgetItemRequest"
      responses:
        "200":
          description: Item atualizado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BudgetItemResponse"

  /budgets/{month}/summary:
    get:
      summary: Visualizar Orçamento (Planned vs Actual)
      tags: [Budgets]
      parameters:
        - in: path
          name: month
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Resumo do orçamento
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BudgetSummaryResponse"

  /budgets/batch:
    post:
      summary: Definir Orçamento em Lote
      tags: [Budgets]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetBudgetBatchRequest"
      responses:
        "200":
          description: Sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success

  # ----------------------------------------------------------------------------
  # Picuinhas
  # ----------------------------------------------------------------------------
  /picuinhas/persons:
    get:
      summary: Listar Pessoas e Saldos
      tags: [Picuinhas]
      responses:
        "200":
          description: Lista de pessoas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PersonResponse"
    post:
      summary: Cadastrar Pessoa
      tags: [Picuinhas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePersonRequest"
      responses:
        "201":
          description: Pessoa criada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PersonResponse"

  /picuinhas/entries:
    post:
      summary: Registrar Entrada/Empréstimo
      tags: [Picuinhas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddEntryRequest"
      responses:
        "201":
          description: Entrada registrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PicuinhaEntryResponse"

  # ----------------------------------------------------------------------------
  # Cards
  # ----------------------------------------------------------------------------
  /payment-methods:
    post:
      summary: Criar Meio de Pagamento
      tags: [Cards]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePaymentMethodRequest"
      responses:
        "201":
          description: Criado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentMethodResponse"

  /installments:
    post:
      summary: Criar Compra Parcelada
      tags: [Cards]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInstallmentRequest"
      responses:
        "201":
          description: Parcelamento criado
          content:
            application/json:
              schema:
                type: object
                properties:
                  installment_amount:
                    type: number
                  start_month:
                    type: string

  /payment-methods/{id}/invoice:
    get:
      summary: Visualizar Fatura
      tags: [Cards]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: query
          name: month
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Fatura
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceResponse"

  # ----------------------------------------------------------------------------
  # Planned / Future
  # ----------------------------------------------------------------------------
  /admin/stats:
    get:
      summary: Stats do Sistema (Exemplo Planejado)
      description: Planned
      x-planned: true
      tags: [Reports]
      responses:
        "200":
          description: Stats
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-App-Token

  responses:
    Unauthorized:
      description: Token inválido ou ausente
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    BadRequest:
      description: Erro de validação
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    # --- Common ---
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        request_id:
          type: string

    # --- Category ---
    CreateCategoryRequest:
      type: object
      required: [name, direction]
      properties:
        name:
          type: string
          example: "Alimentação"
        direction:
          type: string
          enum: [IN, OUT]
          example: "OUT"
        is_budget_relevant:
          type: boolean
          default: true

    CategoryResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        direction:
          type: string
          enum: [IN, OUT]
        is_budget_relevant:
          type: boolean
        is_active:
          type: boolean

    # --- CashFlow ---
    CreateCashFlowRequest:
      type: object
      required: [date, category_id, direction, title, amount]
      properties:
        date:
          type: string
          format: date
          example: "2024-03-20"
        category_id:
          type: integer
        direction:
          type: string
          enum: [IN, OUT]
        title:
          type: string
        amount:
          type: number
          format: float
        is_fixed:
          type: boolean

    CashFlowResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        date:
          type: string
          format: date
        category_id:
          type: integer
        direction:
          type: string
        title:
          type: string
        amount:
          type: number
        is_fixed:
          type: boolean

    MonthlySummaryResponse:
      type: object
      properties:
        total_income:
          type: number
        total_expense:
          type: number
        balance:
          type: number

    CategorySummaryResponse:
      type: object
      properties:
        category_name:
          type: string
        direction:
          type: string
        total_amount:
          type: number

    CopyFixedRequest:
      type: object
      required: [from_month, to_month]
      properties:
        from_month:
          type: string
          example: "2024-02-01"
        to_month:
          type: string
          example: "2024-03-01"

    # --- Budget ---
    SetBudgetItemRequest:
      type: object
      required: [category_id, planned_amount]
      properties:
        category_id:
          type: integer
        planned_amount:
          type: number

    SetBudgetBatchRequest:
      type: object
      required: [start_month, end_month, category_id, planned_amount]
      properties:
        start_month:
          type: string
          example: "2024-01-01"
        end_month:
          type: string
          example: "2024-12-01"
        category_id:
          type: integer
        planned_amount:
          type: number

    BudgetItemResponse:
      type: object
      properties:
        id:
          type: integer
        budget_period_id:
          type: integer
        category_id:
          type: integer
        category_name:
          type: string
        mode:
          type: string
          example: "ABSOLUTE"
        planned_amount:
          type: number
        actual_amount:
          type: number

    BudgetSummaryResponse:
      type: object
      properties:
        month:
          type: string
        items:
          type: array
          items:
            $ref: "#/components/schemas/BudgetItemResponse"

    # --- Picuinhas ---
    CreatePersonRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        notes:
          type: string

    PersonResponse:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        notes:
          type: string
        balance:
          type: number

    AddEntryRequest:
      type: object
      required: [person_id, kind, amount]
      properties:
        person_id:
          type: integer
        kind:
          type: string
          enum: [PLUS, MINUS]
        amount:
          type: number
        cash_flow_id:
          type: integer
          nullable: true
        auto_create_flow:
          type: boolean

    PicuinhaEntryResponse:
      type: object
      properties:
        id:
          type: integer
        person_id:
          type: integer
        amount:
          type: number
        kind:
          type: string
        cash_flow_id:
          type: integer
          nullable: true
        created_at:
          type: string
          format: date-time

    # --- Cards ---
    CreatePaymentMethodRequest:
      type: object
      required: [name, kind, bank_name]
      properties:
        name:
          type: string
        kind:
          type: string
          example: "CREDIT_CARD"
        bank_name:
          type: string
        closing_day:
          type: integer
        due_day:
          type: integer

    PaymentMethodResponse:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        kind:
          type: string
        bank_name:
          type: string
        closing_day:
          type: integer
        due_day:
          type: integer
        is_active:
          type: boolean

    CreateInstallmentRequest:
      type: object
      required:
        [
          description,
          total_amount,
          count,
          category_id,
          payment_method_id,
          purchase_date,
        ]
      properties:
        description:
          type: string
        total_amount:
          type: number
        count:
          type: integer
        category_id:
          type: integer
        payment_method_id:
          type: integer
        purchase_date:
          type: string
          format: date

    InvoiceResponse:
      type: object
      properties:
        payment_method_id:
          type: integer
        month:
          type: string
        total:
          type: number
        entries:
          type: array
          items:
            type: object
            properties:
              cash_flow_id:
                type: integer
              date:
                type: string
              title:
                type: string
              amount:
                type: number
              category_name:
                type: string
